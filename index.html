<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beer Tour Bologna - Marco's 30th Birthday</title>

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Beer Tour">
    <meta name="theme-color" content="#FDB927">

    <!-- Apple Touch Icon (Icona Gialla) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%23FDB927'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='90' fill='%232C2C2C'>üç∫</text></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23FDB927'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='60' fill='%232C2C2C'>üç∫</text></svg>">

    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #FDB927 0%, #F4A300 50%, #D4880F 100%);
            min-height: 100vh;
            height: 100vh; /* Fixed height to prevent overflow */
            padding-bottom: 0;
            position: fixed; /* Fixed to prevent scroll bounce */
            width: 100%;
            overflow: hidden; /* Hide overflow to prevent background showing */
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 200, 0, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            background: #FFFFFF;
            height: 100vh; /* Fixed height instead of min-height */
            position: relative;
            box-shadow: 0 0 60px rgba(0,0,0,0.3);
            z-index: 1;
            overscroll-behavior: contain;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* Welcome Screen */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #FDB927 0%, #F4A300 50%, #D4880F 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: #2C2C2C;
            padding: 20px;
            overflow: hidden;
            overscroll-behavior: none;
            touch-action: none;
        }

        .welcome-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 30% 40%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(212, 136, 15, 0.2) 0%, transparent 50%);
            pointer-events: none;
        }

        .welcome-screen.hidden {
            display: none;
        }

        .welcome-content {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
        }

        .welcome-title {
            font-size: 32px;
            text-align: center;
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            font-size: 16px;
            text-align: center;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .profile-setup {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .profile-input {
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 10px;
            font-size: 16px;
        }

        .profile-input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .profile-input:focus {
            outline: none;
            border-color: white;
            background: rgba(255,255,255,0.2);
        }

        .profile-row {
            display: flex;
            gap: 10px;
        }

        .profile-row .profile-input {
            flex: 1;
        }

        .profile-select {
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .profile-select option {
            background: #667eea;
            color: white;
        }

        .profile-avatars {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 10px 0;
        }

        .avatar-option {
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            font-size: 30px;
            text-align: center;
            transition: all 0.3s;
        }

        .avatar-option:hover {
            background: rgba(255,255,255,0.2);
        }

        .avatar-option.selected {
            border-color: white;
            background: rgba(255,255,255,0.3);
        }

        .start-button {
            padding: 15px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .start-button:active {
            transform: scale(0.98);
        }

        .header {
            background: linear-gradient(135deg, #FDB927 0%, #F4A300 100%);
            color: #2C2C2C;
            padding: 12px 15px; /* Reduced from 18px 20px for slimmer header */
            text-align: center;
            position: fixed; /* Changed from sticky to fixed */
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999; /* Increased z-index to stay above everything */
            box-shadow: 0 4px 20px rgba(253, 185, 39, 0.3);
            border-bottom: 3px solid rgba(255, 255, 255, 0.3);
            max-width: 480px; /* Match container width */
            margin: 0 auto; /* Center on large screens */
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            flex: 1;
            text-align: left;
        }

        .header-center {
            flex: 2;
            text-align: center;
        }

        .header-right {
            flex: 1;
            text-align: right;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 5px; /* Reduced from 10px to bring elements closer */
            font-size: 13px; /* Reduced from 18px to save space */
            font-weight: 600; /* Slightly lighter */
        }

        .user-avatar {
            font-size: 18px; /* Reduced from 28px to save space */
        }

        .header h1 {
            font-size: 18px; /* Slightly smaller for better proportion */
            margin: 0;
            font-weight: 700;
        }

        .header .subtitle {
            font-size: 11px; /* Slightly smaller */
            opacity: 0.85;
            margin-top: 2px;
        }

        .share-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.4); /* Thicker border */
            color: white;
            padding: 6px 12px; /* Reduced for slimmer header */
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px; /* Reduced from 15px */
            font-weight: 700; /* Bold */
            transition: all 0.3s;
        }

        .share-btn:hover {
            background: rgba(255,255,255,0.35);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .share-btn:active {
            transform: scale(0.95);
        }

        .tab-nav {
            display: flex;
            background: white;
            border-bottom: 2px solid #f0f0f0;
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 480px;
            width: 100%;
            z-index: 9998; /* Just below header */
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            border-top: 1px solid #e0e0e0; /* Extra visual anchor */
        }

        .tab-btn {
            position: relative;
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #666;
            min-width: 0;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #FDB927 0%, #F4A300 100%);
            color: #2C2C2C;
            font-weight: 900;
            box-shadow: 0 2px 10px rgba(253, 185, 39, 0.3);
        }

        .tab-btn .icon {
            font-size: 26px;
        }

        .tab-btn span:last-child {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* Notification Badge for Challenges */
        .notification-badge {
            position: absolute;
            top: 3px;
            right: 5px;
            background: #FF0000;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 900;
            box-shadow: 0 2px 8px rgba(255, 0, 0, 0.5);
            animation: badgePulse 2s ease-in-out infinite;
            z-index: 1000;
            pointer-events: none;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* TROPHY ICON RED - New challenges notification */
        /* Aumentiamo la specificit√† per override forzato */
        .tab-btn .icon i.trophy-has-new-challenges,
        .tab-btn.active .icon i.trophy-has-new-challenges,
        i.fas.fa-trophy.trophy-has-new-challenges {
            color: #FF0000 !important;
            animation: trophyPulse 2s ease-in-out infinite !important;
            filter: brightness(1.3) drop-shadow(0 0 8px rgba(255, 0, 0, 0.8)) !important;
        }

        @keyframes trophyPulse {
            0%, 100% {
                transform: scale(1);
                filter: brightness(1.3) drop-shadow(0 0 8px rgba(255, 0, 0, 0.8));
            }
            50% {
                transform: scale(1.15);
                filter: brightness(1.5) drop-shadow(0 0 12px rgba(255, 0, 0, 1));
            }
        }

        .tab-content {
            display: none;
            padding: 20px;
            padding-top: 90px; /* Space for fixed header to prevent content overlap */
            padding-bottom: 100px; /* Space for footer to prevent content being covered */
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* BEER LIQUID THERMOMETER - Professional Design */
        .thermometer-container {
            background: linear-gradient(145deg, #FFFFFF 0%, #FFF9E6 100%);
            padding: 30px 20px;
            border-radius: 25px;
            box-shadow:
                0 20px 50px rgba(253, 185, 39, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border: 3px solid #2C2C2C;
        }

        .thermometer-container::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(253, 185, 39, 0.08) 0%, transparent 70%);
            animation: shimmer 10s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translate(0, 0); opacity: 0.5; }
            50% { transform: translate(-40px, -40px); opacity: 0.8; }
        }

        .thermometer-visual {
            position: relative;
            width: 100%;
            max-width: 340px;
            height: 120px;
            margin: 20px auto 100px auto;
            background: #F5F5F5;
            border-radius: 60px;
            box-shadow:
                inset 0 6px 20px rgba(0,0,0,0.15),
                0 6px 25px rgba(0,0,0,0.1);
            padding: 12px;
            z-index: 1;
            border: 4px solid #2C2C2C;
        }

        .thermometer-track {
            width: 100%;
            height: 100%;
            border-radius: 48px;
            position: relative;
            overflow: hidden;
            background: #FAFAFA;
            box-shadow: inset 0 3px 10px rgba(0,0,0,0.1);
        }

        /* BEER LIQUID FILL - HORIZONTAL (Left to Right) */
        .beer-liquid {
            position: absolute;
            top: 3px;
            bottom: 3px;
            left: 3px;
            width: 0%;
            max-width: calc(100% - 6px);
            background: linear-gradient(to right,
                #C77A0A 0%,
                #D4880F 3%,
                #F4A300 10%,
                #FDB927 20%,
                #FFC850 45%,
                #FFD670 75%,
                #FFE490 92%,
                #FFF2B0 100%);
            border-radius: 45px 0 0 45px;
            transition: width 1.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
            box-shadow: inset -2px 0 8px rgba(0,0,0,0.1);
        }

        /* When at 100%, use full border-radius and adjust right position */
        .beer-liquid[style*="width: 100"] {
            border-radius: 45px;
            right: 3px;
            width: calc(100% - 6px) !important;
        }

        /* Beer Foam Effect at the END (Right Side) - Beautiful Closure */
        .beer-liquid::before {
            content: '';
            position: absolute;
            top: 50%;
            right: 2px;
            transform: translateY(-50%);
            width: 35px;
            height: 105%;
            background: radial-gradient(ellipse at center,
                rgba(255, 255, 255, 0.98) 0%,
                rgba(255, 255, 255, 0.92) 20%,
                rgba(255, 255, 255, 0.8) 40%,
                rgba(255, 255, 255, 0.5) 65%,
                rgba(255, 235, 176, 0.3) 80%,
                transparent 100%);
            border-radius: 50%;
            filter: blur(4px);
            animation: foamBubble 2.5s ease-in-out infinite;
            z-index: 2;
        }

        @keyframes foamBubble {
            0%, 100% {
                transform: translateY(-50%) scaleX(1) scaleY(1);
                opacity: 0.95;
                filter: blur(4px);
            }
            50% {
                transform: translateY(-50%) scaleX(1.15) scaleY(0.92);
                opacity: 1;
                filter: blur(3px);
            }
        }

        /* Dynamic Bubbles - Moving & Rising Animation */
        .beer-liquid::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 12% 65%, rgba(255, 255, 255, 0.5) 0%, rgba(255, 255, 255, 0.3) 1%, transparent 3%),
                radial-gradient(circle at 28% 45%, rgba(255, 255, 255, 0.45) 0%, rgba(255, 255, 255, 0.25) 1.2%, transparent 3.5%),
                radial-gradient(circle at 45% 75%, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.2) 1%, transparent 2.8%),
                radial-gradient(circle at 58% 35%, rgba(255, 255, 255, 0.5) 0%, rgba(255, 255, 255, 0.3) 1.5%, transparent 4%),
                radial-gradient(circle at 72% 60%, rgba(255, 255, 255, 0.45) 0%, rgba(255, 255, 255, 0.25) 1.2%, transparent 3.2%),
                radial-gradient(circle at 85% 50%, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.2) 1%, transparent 3%),
                radial-gradient(circle at 20% 85%, rgba(255, 255, 255, 0.35) 0%, rgba(255, 255, 255, 0.15) 1%, transparent 2.5%),
                radial-gradient(circle at 38% 25%, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.2) 1.2%, transparent 3.5%),
                radial-gradient(circle at 63% 80%, rgba(255, 255, 255, 0.45) 0%, rgba(255, 255, 255, 0.25) 1%, transparent 3%),
                radial-gradient(circle at 78% 40%, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.2) 1%, transparent 2.8%),
                radial-gradient(circle at 92% 70%, rgba(255, 255, 255, 0.35) 0%, rgba(255, 255, 255, 0.15) 1.2%, transparent 3.2%);
            background-size: 100% 100%;
            animation: bubblesRise 4s ease-in-out infinite;
            border-radius: 48px;
            z-index: 1;
        }

        @keyframes bubblesRise {
            0% {
                opacity: 0.6;
                transform: translateY(0) translateX(0);
                background-position: 0% 0%, 5% 10%, 10% 5%, 15% 15%, 20% 8%, 25% 12%, 30% 6%, 35% 14%, 40% 10%, 45% 8%, 50% 12%;
            }
            25% {
                opacity: 0.8;
                transform: translateY(-3px) translateX(2px);
                background-position: 2% -8%, 7% 2%, 12% -5%, 17% 5%, 22% -3%, 27% 4%, 32% -6%, 37% 6%, 42% 2%, 47% -4%, 52% 4%;
            }
            50% {
                opacity: 1;
                transform: translateY(-6px) translateX(-2px);
                background-position: 3% -15%, 8% -5%, 13% -12%, 18% -3%, 23% -8%, 28% -2%, 33% -14%, 38% -4%, 43% -6%, 48% -10%, 53% -2%;
            }
            75% {
                opacity: 0.8;
                transform: translateY(-3px) translateX(1px);
                background-position: 2% -8%, 7% 2%, 12% -5%, 17% 5%, 22% -3%, 27% 4%, 32% -6%, 37% 6%, 42% 2%, 47% -4%, 52% 4%;
            }
            100% {
                opacity: 0.6;
                transform: translateY(0) translateX(0);
                background-position: 0% 0%, 5% 10%, 10% 5%, 15% 15%, 20% 8%, 25% 12%, 30% 6%, 35% 14%, 40% 10%, 45% 8%, 50% 12%;
            }
        }

        /* Glossy Effect */
        .thermometer-track::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60%;
            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.4) 0%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 100%);
            border-radius: 48px 48px 0 0;
            pointer-events: none;
        }

        /* RED LINE Indicator - Follows Beer Level and Border Perimeter */
        .thermometer-pointer {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(to bottom,
                #FF0000 0%,
                #DC143C 50%,
                #FF0000 100%);
            transition: left 1.5s cubic-bezier(0.34, 1.56, 0.64, 1), height 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 30;
            box-shadow:
                0 0 8px rgba(255, 0, 0, 0.6),
                0 0 15px rgba(255, 0, 0, 0.4),
                inset 0 0 2px rgba(255, 255, 255, 0.5);
            animation: indicatorPulse 2s ease-in-out infinite;
            display: none;
        }

        /* Show pointer only when there's beer */
        .thermometer-pointer.visible {
            display: block;
        }

        @keyframes indicatorPulse {
            0%, 100% {
                box-shadow:
                    0 0 8px rgba(255, 0, 0, 0.6),
                    0 0 15px rgba(255, 0, 0, 0.4),
                    inset 0 0 2px rgba(255, 255, 255, 0.5);
            }
            50% {
                box-shadow:
                    0 0 12px rgba(255, 0, 0, 0.8),
                    0 0 20px rgba(255, 0, 0, 0.6),
                    inset 0 0 3px rgba(255, 255, 255, 0.7);
            }
        }

        /* Face Icon Container - Centered & Balanced */
        .thermometer-face {
            position: absolute;
            top: 135px;
            font-size: 48px;
            transition: all 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            left: 50%;
            transform: translateX(-50%);
            z-index: 5;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.15));
            text-align: center;
        }

        .thermometer-face i {
            color: #FDB927;
            animation: faceFloat 3s ease-in-out infinite;
            display: inline-block;
        }

        @keyframes faceFloat {
            0%, 100% { transform: translateY(0) rotate(0deg) scale(1); }
            50% { transform: translateY(-6px) rotate(3deg) scale(1.05); }
        }

        .thermometer-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 0 15px;
            font-size: 13px;
            color: #2C2C2C;
            font-weight: 700;
            z-index: 1;
            position: relative;
        }

        .scale-item {
            text-align: center;
            background: rgba(253, 185, 39, 0.15);
            padding: 6px 10px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(253, 185, 39, 0.3);
            box-shadow: 0 2px 8px rgba(253, 185, 39, 0.2);
        }

        .thermometer-overflow-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #2C2C2C;
            font-weight: 900;
            font-size: 20px;
            text-shadow:
                0 2px 4px rgba(255,255,255,0.8),
                0 0 15px rgba(253,185,39,0.6);
            display: none;
            z-index: 25;
            animation: overflowBlink 1s ease-in-out infinite;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #FDB927;
        }

        @keyframes overflowBlink {
            0%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.05); }
        }

        .current-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
            text-align: center;
            gap: 12px;
        }

        .stat-display {
            flex: 1;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 18px 12px;
            border-radius: 18px;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid rgba(253, 185, 39, 0.3);
            box-shadow: 0 4px 15px rgba(253, 185, 39, 0.15);
        }

        .stat-display:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(253, 185, 39, 0.3);
        }

        .stat-emoji {
            font-size: 36px;
            margin-bottom: 8px;
            filter: drop-shadow(0 2px 4px rgba(253, 185, 39, 0.3));
        }

        .stat-emoji i {
            color: #FDB927;
            animation: statFloat 3s ease-in-out infinite;
        }

        @keyframes statFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .stat-value {
            font-size: 30px;
            font-weight: 900;
            color: #2C2C2C;
            letter-spacing: 0.5px;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* Tour Progress */
        .tour-progress {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            padding: 25px;
            border-radius: 20px;
            box-shadow:
                0 10px 30px rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.9);
            margin-bottom: 20px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .progress-time {
            font-size: 14px;
            color: #666;
        }

        .stops-timeline {
            position: relative;
            padding: 10px 0;
        }

        .timeline-line {
            position: absolute;
            top: 25px;
            left: 22.5px; /* Center of first circle (45px/2) */
            right: 22.5px; /* Center of last circle */
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }

        .timeline-progress {
            position: absolute;
            top: 25px;
            left: 22.5px; /* Center of first circle */
            height: 2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 2;
            transition: width 0.5s;
            max-width: calc(100% - 45px); /* Ensure it doesn't go beyond last circle */
        }

        .stops-container {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 3;
        }

        .stop-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .stop-item:hover {
            transform: scale(1.1);
        }

        .stop-circle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: white;
            border: 3px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 5px;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stop-item.completed .stop-circle {
            border-color: #4caf50;
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.4);
        }

        .stop-item.current .stop-circle {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation: pulse 2s infinite, rotate 3s linear infinite;
            transform: scale(1.15);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7), 0 6px 12px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(102, 126, 234, 0), 0 8px 16px rgba(102, 126, 234, 0.6); }
        }

        @keyframes rotate {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .stop-name {
            font-size: 10px;
            color: #666;
            text-align: center;
            max-width: 60px;
        }

        .stop-time {
            font-size: 9px;
            color: #999;
        }

        /* Selected Stop Info */
        .selected-stop-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            color: white;
            box-shadow:
                0 8px 20px rgba(79, 172, 254, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s;
        }

        .selected-stop-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(79, 172, 254, 0.4);
        }

        .stop-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stop-details-left {
            flex: 1;
        }

        .stop-details-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stop-details-address {
            font-size: 12px;
            opacity: 0.9;
        }

        .stop-details-time {
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
        }

        .navigation-button {
            width: 100%;
            padding: 14px;
            background: white;
            color: #4facfe;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .navigation-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .navigation-button:active {
            transform: scale(0.96);
        }

        /* Beer Counter */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            margin-top: 10px; /* Add space below header to prevent overlap */
        }

        .stat-card {
            background: linear-gradient(135deg, #FDB927 0%, #F4A300 100%);
            padding: 25px 20px;
            border-radius: 18px;
            color: #2C2C2C;
            text-align: center;
            box-shadow:
                0 8px 20px rgba(253, 185, 39, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.3);
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: shimmer 6s ease-in-out infinite;
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 30px rgba(253, 185, 39, 0.4);
        }

        .stat-card.gradient-2 {
            background: linear-gradient(135deg, #FFD670 0%, #FFC850 100%);
            box-shadow:
                0 8px 20px rgba(255, 214, 112, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }

        .stat-card.gradient-3 {
            background: linear-gradient(135deg, #FFFFFF 0%, #FFF9E6 100%);
            box-shadow:
                0 8px 20px rgba(253, 185, 39, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.5);
            border: 2px solid rgba(253, 185, 39, 0.3);
        }

        .stat-card.gradient-4 {
            background: linear-gradient(135deg, #D4880F 0%, #C77A0A 100%);
            color: white;
            box-shadow:
                0 8px 20px rgba(212, 136, 15, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .beer-selector {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .beer-selector h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .beer-sizes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .beer-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .type-btn {
            padding: 10px 8px;
            border: 2px solid #2C2C2C;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: #666;
        }

        .type-btn.selected {
            background: linear-gradient(135deg, #F4A300 0%, #FDB927 100%);
            color: #2C2C2C;
            border: 2px solid #2C2C2C;
            box-shadow: 0 4px 12px rgba(253, 185, 39, 0.3);
        }

        .size-btn {
            padding: 15px 10px;
            border: 3px solid #2C2C2C;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .size-btn.selected {
            background: linear-gradient(135deg, #FDB927 0%, #F4A300 100%);
            color: #2C2C2C;
            border: 3px solid #2C2C2C;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(253, 185, 39, 0.3);
        }

        .size-btn .size {
            font-size: 20px;
            font-weight: bold;
        }

        .size-btn .volume {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .alcohol-input {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
            background: linear-gradient(145deg, #FFFFFF, #FFF9E6);
            padding: 18px;
            border-radius: 15px;
            border: 2px solid #2C2C2C;
            box-shadow: 0 4px 12px rgba(253, 185, 39, 0.15);
        }

        .alcohol-input label {
            color: #2C2C2C;
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alcohol-value-display {
            font-size: 24px;
            color: #FDB927;
            font-weight: 900;
            background: #2C2C2C;
            padding: 8px 16px;
            border-radius: 12px;
            min-width: 85px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .alcohol-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 12px;
            border-radius: 10px;
            background: linear-gradient(to right,
                #4CAF50 0%,
                #CDDC39 15%,
                #FDB927 30%,
                #FF9800 50%,
                #FF5722 75%,
                #F44336 100%);
            outline: none;
            border: 2px solid #2C2C2C;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .alcohol-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(145deg, #FFFFFF, #F0F0F0);
            cursor: pointer;
            border: 3px solid #2C2C2C;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }

        .alcohol-slider::-webkit-slider-thumb:active {
            transform: scale(1.2);
            box-shadow: 0 6px 16px rgba(253, 185, 39, 0.5);
        }

        .alcohol-slider::-moz-range-thumb {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(145deg, #FFFFFF, #F0F0F0);
            cursor: pointer;
            border: 3px solid #2C2C2C;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }

        .alcohol-slider::-moz-range-thumb:active {
            transform: scale(1.2);
            box-shadow: 0 6px 16px rgba(253, 185, 39, 0.5);
        }

        .alcohol-presets {
            display: flex;
            gap: 8px;
            justify-content: space-between;
            margin-top: 8px;
        }

        .preset-btn {
            flex: 1;
            padding: 8px 6px;
            background: white;
            border: 2px solid #2C2C2C;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .preset-btn:active {
            transform: scale(0.95);
            background: linear-gradient(135deg, #FDB927, #F4A300);
            color: #2C2C2C;
        }

        .add-beer-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #FDB927 0%, #F4A300 100%);
            color: #2C2C2C;
            border: 3px solid #2C2C2C;
            border-radius: 14px;
            font-size: 18px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow:
                0 8px 20px rgba(253, 185, 39, 0.4),
                inset 0 2px 0 rgba(255,255,255,0.4);
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .add-beer-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.4);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .add-beer-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(253, 185, 39, 0.5);
        }

        .add-beer-btn:hover::before {
            width: 350px;
            height: 350px;
        }

        .add-beer-btn:active {
            transform: scale(0.96);
        }

        .beer-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 10px;
        }

        .beer-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 2px solid #2C2C2C;
        }

        .beer-item-info {
            flex: 1;
        }

        .beer-item-location {
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .beer-item-details {
            font-size: 12px;
            color: #666;
        }

        .remove-beer {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Share Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .modal-close {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 80px; /* Below header (75px + margin) */
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 9997; /* Below header but above everything else */
            animation: slideDown 0.5s;
            display: none;
            max-width: 90%;
            text-align: center;
            font-weight: 600;
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .notification.show {
            display: block;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-transform-style: preserve-3d;
            transform-style: preserve-3d;
            will-change: transform;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: #999;
        }

        .nav-item.active {
            color: #FDB927;
            font-weight: 700;
        }

        .nav-item .icon {
            font-size: 24px;
        }

        .nav-item .label {
            font-size: 10px;
        }

        /* Challenges/Achievements - Beer Theme */
        .challenges-list {
            display: grid;
            gap: 15px;
        }

        .challenge-card {
            background: linear-gradient(145deg, #FFFFFF, #FFF9E6);
            padding: 18px;
            border-radius: 18px;
            box-shadow: 0 4px 15px rgba(253, 185, 39, 0.15);
            border: 3px solid #2C2C2C;
            position: relative;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            overflow: hidden;
        }

        .challenge-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(253, 185, 39, 0.3);
        }

        .challenge-card.completed {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            border: 3px solid #2C2C2C;
        }

        .challenge-card.completed::after {
            content: "‚úì";
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: white;
            background: rgba(255,255,255,0.3);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* NEW Badge for newly unlocked challenges */
        .challenge-card.new-unlock::before {
            content: "NEW!";
            position: absolute;
            top: 10px;
            left: 10px;
            background: #FF0000;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 900;
            box-shadow: 0 2px 8px rgba(255, 0, 0, 0.5);
            animation: badgePulse 2s ease-in-out infinite;
            z-index: 10;
        }

        .challenge-icon {
            font-size: 36px;
            margin-bottom: 12px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .challenge-icon i {
            color: #FDB927;
        }

        .challenge-card.completed .challenge-icon i {
            color: white;
        }

        .challenge-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 16px;
            color: #2C2C2C;
        }

        .challenge-card.completed .challenge-title {
            color: white;
        }

        .challenge-description {
            font-size: 14px;
            opacity: 0.85;
            line-height: 1.4;
            color: #666;
        }

        .challenge-card.completed .challenge-description {
            color: rgba(255,255,255,0.9);
        }

        .challenge-points {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #FDB927, #F4A300);
            color: #2C2C2C;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 900;
            box-shadow: 0 3px 8px rgba(253, 185, 39, 0.4);
        }



        /* Mobile Responsive */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
                box-shadow: none;
            }
        }

        /* Sync Overlay - Blocco UI durante sincronizzazione */
        .sync-overlay {
            display: none; /* Nascosto di default */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(44, 44, 44, 0.95);
            z-index: 99999; /* Sopra tutto */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            touch-action: none; /* Blocca tutti i touch */
            pointer-events: all; /* Cattura tutti gli eventi */
        }

        .sync-overlay.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Spinner animato */
        .sync-spinner {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(253, 185, 39, 0.2);
            border-top: 8px solid #FDB927;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(253, 185, 39, 0.5);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Testo sincronizzazione */
        .sync-text {
            color: #FDB927;
            font-size: 24px;
            font-weight: 900;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(253, 185, 39, 0.5);
        }

        .sync-subtext {
            color: #FFFFFF;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            opacity: 0.8;
        }

        /* Animazione pulsante */
        .sync-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <!-- Sync Overlay - Blocco UI durante sincronizzazione -->
    <div id="syncOverlay" class="sync-overlay">
        <div class="sync-spinner"></div>
        <div class="sync-text">üîÑ Sincronizzazione in corso...</div>
        <div class="sync-subtext">Attendere prego, non chiudere l'app</div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="welcome-content">
            <div class="welcome-title">üç∫ Beer Tour Bologna</div>
            <div class="welcome-subtitle">30¬∞ Compleanno di Marco ‚Ä¢ 1 Novembre 2025</div>
            
            <div class="profile-setup">
                <input type="text" id="userName" class="profile-input" placeholder="Il tuo nome..." maxlength="20">

                <div class="profile-row">
                    <input type="number" id="userWeight" class="profile-input" placeholder="Peso (kg)" min="40" max="150">
                    <input type="number" id="userHeight" class="profile-input" placeholder="Altezza (cm)" min="140" max="220">
                </div>

                <select id="userGender" class="profile-select">
                    <option value="male">üöπ Uomo</option>
                    <option value="female">üö∫ Donna</option>
                </select>

                <!-- Departure Time Picker -->
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 700; font-size: 14px;">‚è∞ Orario di Partenza</label>
                    <input type="time" id="departureTime" class="profile-input" value="16:00" style="font-size: 18px; text-align: center; font-weight: 700;">
                </div>

                <div class="profile-avatars" id="avatarGrid">
                    <!-- Avatars will be generated -->
                </div>

                <button class="start-button" onclick="startApp()">üéâ Inizia il Tour!</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="user-info" style="cursor: pointer;" onclick="openSettings()">
                        <span class="user-avatar" id="userAvatar"><i class="fas fa-beer"></i></span>
                        <span id="userNameDisplay">Guest</span>
                        <span style="margin-left: 3px; opacity: 0.8; font-size: 16px;"><i class="fas fa-gear"></i></span>
                    </div>
                </div>
                <div class="header-center">
                    <h1><i class="fas fa-beer-mug-empty"></i> Beer Tour</h1>
                    <div class="subtitle">Marco's 30th <i class="fas fa-cake-candles"></i></div>
                </div>
                <div class="header-right" style="display: flex; gap: 10px; justify-content: flex-end; align-items: center;">
                    <button class="share-btn" onclick="syncWithSheet()" title="Sincronizza con gli altri"><i class="fas fa-sync"></i> Sync</button>
                    <button class="share-btn" style="background: rgba(255,100,100,0.3);" onclick="logout()" title="Esci"><i class="fas fa-right-from-bracket"></i> Esci</button>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('home', this)">
                <span class="icon"><i class="fas fa-house"></i></span>
                <span>Home</span>
            </button>
            <button class="tab-btn" onclick="switchTab('counter', this)">
                <span class="icon"><i class="fas fa-beer"></i></span>
                <span>Birre</span>
            </button>
            <button class="tab-btn" onclick="switchTab('challenges', this)">
                <span class="icon"><i class="fas fa-trophy"></i></span>
                <span>Sfide</span>
            </button>
            <button class="tab-btn" onclick="switchTab('scoreboard', this)">
                <span class="icon"><i class="fas fa-chart-simple"></i></span>
                <span>Score</span>
            </button>
        </div>

        <!-- Home Tab with NEW Alcohol Thermometer -->
        <div id="home-tab" class="tab-content active">
            <div class="thermometer-container">
                <div class="thermometer-visual">
                    <div class="thermometer-track">
                        <div class="beer-liquid" id="beerLiquid" style="width: 0%;">
                            <!-- Dynamic bubbles will be added here by CSS -->
                        </div>
                        <div class="thermometer-overflow-indicator" id="overflowIndicator">OVER!</div>
                    </div>
                    <div class="thermometer-pointer" id="thermometerPointer" style="left: 0;"></div>
                    <div class="thermometer-face" id="beerFace">
                        <i class="fas fa-smile"></i>
                    </div>
                </div>
                <div class="thermometer-scale">
                    <div class="scale-item">0‚Ä∞</div>
                    <div class="scale-item">0.5‚Ä∞</div>
                    <div class="scale-item">1.0‚Ä∞</div>
                    <div class="scale-item">1.5‚Ä∞</div>
                    <div class="scale-item">2.0‚Ä∞+</div>
                </div>

                <div class="current-stats">
                    <div class="stat-display">
                        <div class="stat-emoji"><i class="fas fa-beer"></i></div>
                        <div class="stat-value" id="homeBeers">0</div>
                        <div class="stat-label">Birre</div>
                    </div>
                    <div class="stat-display">
                        <div class="stat-emoji"><i class="fas fa-glass-water"></i></div>
                        <div class="stat-value" id="homeLiters">0L</div>
                        <div class="stat-label">Litri</div>
                    </div>
                    <div class="stat-display">
                        <div class="stat-emoji"><i class="fas fa-gauge-high"></i></div>
                        <div class="stat-value" id="homeBAC">0.00‚Ä∞</div>
                        <div class="stat-label">Tasso</div>
                    </div>
                </div>
            </div>

            <div class="tour-progress">
                <div class="progress-header">
                    <span class="progress-title">üìç Tappe del Tour</span>
                    <span class="progress-time" id="tourTime">16:00 - 19:45</span>
                </div>
                <div class="stops-timeline">
                    <div class="timeline-line"></div>
                    <div class="timeline-progress" id="timelineProgress" style="width: 0%;"></div>
                    <div class="stops-container" id="stopsContainer">
                        <!-- Stops will be generated here -->
                    </div>
                </div>
                
                <div class="selected-stop-info" id="selectedStopInfo">
                    <div class="stop-details">
                        <div class="stop-details-left">
                            <div class="stop-details-name" id="stopName">Osteria del Sole</div>
                            <div class="stop-details-address" id="stopAddress">Vicolo Ranocchi 1/D</div>
                        </div>
                        <div class="stop-details-time" id="stopTime">16:00-16:30</div>
                    </div>
                    <button class="navigation-button" onclick="openGoogleMaps()">
                        üìç Apri in Google Maps
                    </button>
                </div>
            </div>
        </div>

        <!-- Counter Tab -->
        <div id="counter-tab" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalBeers">0</div>
                    <div class="stat-label">Birre Totali</div>
                </div>
                <div class="stat-card gradient-2">
                    <div class="stat-value" id="totalLiters">0L</div>
                    <div class="stat-label">Litri Totali</div>
                </div>
                <div class="stat-card gradient-3">
                    <div class="stat-value" id="avgAlcohol">0%</div>
                    <div class="stat-label">Media Alcolica</div>
                </div>
                <div class="stat-card gradient-4">
                    <div class="stat-value" id="currentStop">1/6</div>
                    <div class="stat-label">Tappa Attuale</div>
                </div>
            </div>

            <div class="beer-selector">
                <h3>Aggiungi Birra</h3>
                <div class="beer-sizes">
                    <div class="size-btn" onclick="selectSize('piccola', 0.2, this)">
                        <div class="size">üç∫</div>
                        <div class="volume">Piccola (0.2L)</div>
                    </div>
                    <div class="size-btn selected" onclick="selectSize('media', 0.4, this)">
                        <div class="size">üç∫üç∫</div>
                        <div class="volume">Media (0.4L)</div>
                    </div>
                    <div class="size-btn" onclick="selectSize('grande', 0.5, this)">
                        <div class="size">üç∫üç∫üç∫</div>
                        <div class="volume">Grande (0.5L)</div>
                    </div>
                </div>
                <div class="alcohol-input">
                    <label for="alcoholSlider">
                        <span>Gradazione Alcolica</span>
                        <span class="alcohol-value-display" id="alcoholValue">5.0%</span>
                    </label>
                    <input type="range" id="alcoholSlider" class="alcohol-slider"
                           value="5.0" min="0" max="20" step="0.5"
                           oninput="updateAlcoholValue(this.value)">
                    <div class="alcohol-presets">
                        <button class="preset-btn" onclick="setAlcohol(3.5)">Leggera<br>3.5%</button>
                        <button class="preset-btn" onclick="setAlcohol(5.0)">Media<br>5.0%</button>
                        <button class="preset-btn" onclick="setAlcohol(7.0)">Forte<br>7.0%</button>
                        <button class="preset-btn" onclick="setAlcohol(10.0)">Doppio<br>10.0%</button>
                        <button class="preset-btn" onclick="setAlcohol(12.0)">Triplo<br>12.0%</button>
                    </div>
                </div>

                <label style="display: block; margin-bottom: 8px; color: #666; font-weight: 600;">Variet√† Birra:</label>
                <div class="beer-types">
                    <div class="type-btn selected" onclick="selectType('Bionda', this)">üåæ Bionda</div>
                    <div class="type-btn" onclick="selectType('Rossa', this)">üî¥ Rossa</div>
                    <div class="type-btn" onclick="selectType('Scura', this)">‚ö´ Scura</div>
                    <div class="type-btn" onclick="selectType('IPA', this)">üçä IPA</div>
                    <div class="type-btn" onclick="selectType('Lager', this)">üíõ Lager</div>
                    <div class="type-btn" onclick="selectType('Pils', this)">üåø Pils</div>
                    <div class="type-btn" onclick="selectType('Stout', this)">‚òï Stout</div>
                    <div class="type-btn" onclick="selectType('Weiss', this)">üå§Ô∏è Weiss</div>
                </div>

                <button class="add-beer-btn" onclick="addBeer()">
                    ‚ûï Aggiungi Birra
                </button>
            </div>

            <div class="beer-list" id="beerList">
                <!-- Beer items will be added here -->
            </div>
        </div>

        <!-- Challenges Tab -->
        <div id="challenges-tab" class="tab-content">
            <h3 style="color: #2C2C2C; margin-bottom: 20px; font-size: 20px;">
                <i class="fas fa-trophy" style="color: #FDB927; margin-right: 8px;"></i>
                Sfide & Achievements
            </h3>
            <div class="challenges-list" id="challengesList">
                <!-- Challenges will be loaded here -->
            </div>
        </div>

        <!-- Scoreboard Tab -->
        <div id="scoreboard-tab" class="tab-content">
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 60px; margin-bottom: 20px;">üìä</div>
                <h2 style="color: #667eea; margin-bottom: 15px;">Classifica Gruppo</h2>
                <p style="color: #666; margin-bottom: 30px;">La classifica condivisa sar√† disponibile quando tutti i 7 amici avranno iniziato il tour!</p>
                <div style="background: linear-gradient(145deg, #f8f9fa, #e9ecef); padding: 25px; border-radius: 20px; text-align: left;">
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 14px; color: #999; margin-bottom: 5px;">I tuoi progressi:</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <span style="background: #667eea; color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: bold;" id="yourRank">In attesa...</span>
                        </div>
                    </div>
                    <div style="font-size: 13px; color: #666; line-height: 1.6;">
                        üí° <strong>Suggerimento:</strong> Usa il pulsante "Sync" in alto per sincronizzare i tuoi progressi con gli amici!
                    </div>
                </div>
                <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="font-weight: bold; margin-bottom: 15px; color: #333;">üéØ I tuoi record personali:</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="recordBeers">0</div>
                            <div style="font-size: 11px; color: #666;">Birre bevute</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: bold; color: #f093fb;" id="recordBAC">0.00‚Ä∞</div>
                            <div style="font-size: 11px; color: #666;">Tasso massimo</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="quickNav('home', this)">
            <span class="icon"><i class="fas fa-house"></i></span>
            <span class="label">Home</span>
        </div>
        <div class="nav-item" onclick="quickNav('counter', this)">
            <span class="icon"><i class="fas fa-beer"></i></span>
            <span class="label">Birre</span>
        </div>
        <div class="nav-item" onclick="quickNav('challenges', this)">
            <span class="icon"><i class="fas fa-trophy"></i></span>
            <span class="label">Sfide</span>
        </div>
        <div class="nav-item" onclick="quickNav('scoreboard', this)">
            <span class="icon"><i class="fas fa-chart-simple"></i></span>
            <span class="label">Score</span>
        </div>
    </div>

    <script>
        // App State
        let appState = {
            user: {
                name: 'Guest',
                avatar: '<i class="fas fa-beer"></i>',
                id: null
            },
            currentLocation: 0,
            beers: [],
            selectedSize: 'media',
            selectedVolume: 0.4,
            selectedType: 'Bionda',
            points: 0,
            weight: 70,
            height: 175,
            gender: 'male',
            challenges: [],
            beersPerLocation: [0, 0, 0, 0, 0, 0],
            stopArrivalTimes: []
        };

        // Badge notification tracking
        let unlockedChallengesCount = 0;
        let hasVisitedChallenges = false;

        // Challenges Data with Font Awesome icons
        const challengesData = [
            // 1. Too Old to Die Young
            { id: 1, icon: "fa-cake-candles", title: "Too Old to Die Young", description: "Achievement speciale per 'Prosciutto'", points: 100, completed: false, autoUnlock: true },

            // 2. Rizzi (ex Selfie Master)
            { id: 2, icon: "fa-camera", title: "Rizzi", description: "Fai un selfie di gruppo in ogni tappa", points: 50, completed: false },

            // 3. Gourmet
            { id: 3, icon: "fa-pizza-slice", title: "Gourmet", description: "Prendi mortadella all'Osteria del Sole", points: 5, completed: false },

            // 4. Partenza Rinfrescante
            { id: 4, icon: "fa-snowflake", title: "Partenza Rinfrescante", description: "Birra bionda o weiss come prima birra", points: 5, completed: false, autoUnlock: true },

            // 5. Partenza Ribaltante
            { id: 5, icon: "fa-bolt", title: "Partenza Ribaltante", description: "Prima birra con gradazione ‚â•7%", points: 15, completed: false, autoUnlock: true },

            // 6. Una Strada in Salita
            { id: 6, icon: "fa-chart-line", title: "Una Strada in Salita", description: "Gradazione media aumenta ad ogni tappa", points: 25, completed: false, autoUnlock: true },

            // 7. Montagne Russe
            { id: 7, icon: "fa-wave-square", title: "Montagne Russe", description: "Gradazione alterna su/gi√π per 3 tappe", points: 35, completed: false, autoUnlock: true },

            // 8. Etilista
            { id: 8, icon: "fa-glass-water", title: "Etilista", description: "BAC ‚â•0.75‚Ä∞ entro la 2¬∞ tappa", points: 15, completed: false, autoUnlock: true },

            // 9. Etilista Pro
            { id: 9, icon: "fa-fire", title: "Etilista Pro", description: "BAC ‚â•1.5‚Ä∞ entro la 3¬∞ tappa", points: 50, completed: false, autoUnlock: true },

            // 10. Etilista Supremo
            { id: 10, icon: "fa-skull-crossbones", title: "Etilista Supremo", description: "BAC ‚â•2.5‚Ä∞ entro la 5¬∞ tappa", points: 100, completed: false, autoUnlock: true },

            // 11. Collezionista
            { id: 11, icon: "fa-wine-bottle", title: "Collezionista", description: "Prova almeno 5 variet√† diverse di birra", points: 30, completed: false, autoUnlock: true },

            // 12. Un Bicchiere di Troppo
            { id: 12, icon: "fa-champagne-glasses", title: "Un Bicchiere di Troppo", description: "Almeno 2 birre in ogni tappa", points: 35, completed: false, autoUnlock: true },

            // 13. Specialista
            { id: 13, icon: "fa-star", title: "Specialista", description: "Prova la specialit√† di ogni birreria", points: 20, completed: false },

            // 14. Normalone
            { id: 14, icon: "fa-mug-saucer", title: "Normalone", description: "Bevi solo birre medie bionde", points: 5, completed: false, autoUnlock: true },

            // 15. Passeggiata Pensionante
            { id: 15, icon: "fa-person-walking", title: "Passeggiata Pensionante", description: "BAC <0.9‚Ä∞ nelle prime 4 tappe", points: -10, completed: false, autoUnlock: true },

            // 16. Pensione Completa
            { id: 16, icon: "fa-bed", title: "Pensione Completa", description: "BAC <1.75‚Ä∞ per tutto il tour", points: -50, completed: false, autoUnlock: true },

            // 17. Esploratore
            { id: 17, icon: "fa-toilet", title: "Esploratore", description: "Visita i bagni di tutte le birrerie", points: 10, completed: false },

            // 18. Lupin
            { id: 18, icon: "fa-mask", title: "Lupin", description: "Ruba un bicchiere in una birreria", points: 50, completed: false },

            // 19. Luminare
            { id: 19, icon: "fa-star-of-david", title: "Luminare", description: "Convinci una ProPal che Israele 'ha fatto bene'", points: 35, completed: false },

            // 20. Supporter
            { id: 20, icon: "fa-handshake", title: "Supporter", description: "Presenta una Simmenthal a Lillo", points: 35, completed: false },

            // 21. Nostalgico
            { id: 21, icon: "fa-music", title: "Nostalgico", description: "Canta 'Faccetta Nera' o 'Giovinezza'", points: 35, completed: false },

            // 22. Casa Pound
            { id: 22, icon: "fa-hand", title: "Casa Pound", description: "Fai il saluto romano", points: 15, completed: false },

            // 23. Baffino
            { id: 23, icon: "fa-book", title: "Baffino", description: "Leggi Mein Kampf su uno sgabello", points: 180, completed: false },

            // 24. Scroccone
            { id: 24, icon: "fa-cookie-bite", title: "Scroccone", description: "Chiedi un drummino ad una comunistaccia", points: 10, completed: false },

            // 25. Scroccone Incallito
            { id: 25, icon: "fa-cookie", title: "Scroccone Incallito", description: "Chiedi 3 drummini a tre comunistacce", points: 20, completed: false },

            // 26. Scroccone Spudorato
            { id: 26, icon: "fa-crown", title: "Scroccone Spudorato", description: "Chiedi 5 drummini alla stessa comunistaccia", points: 30, completed: false },

            // 27. Insaziabile
            { id: 27, icon: "fa-smoking", title: "Insaziabile", description: "Fuma iQos mentre fumi Paglione", points: 15, completed: false },

            // 28. Molestatore
            { id: 28, icon: "fa-heart", title: "Molestatore", description: "Provaci con una cameriera", points: 25, completed: false },

            // 29. Molestatore Seriale
            { id: 29, icon: "fa-heart-broken", title: "Molestatore Seriale", description: "Provaci con ogni cameriera", points: 50, completed: false },

            // 30. Leso
            { id: 30, icon: "fa-face-dizzy", title: "Leso", description: "Fai almeno una volta il leso", points: -50, completed: false }
        ];

        // Locations Data with coordinates
        const locations = [
            {
                name: "Osteria del Sole",
                address: "Vicolo Ranocchi 1/D, 40124 Bologna",
                lat: 44.49354,
                lng: 11.34332,
                time: "16:00-16:30",
                emoji: "üèõÔ∏è",
                description: "Fondata nel 1465, √® l'osteria pi√π antica di Bologna! üèõÔ∏è Qui non vendono cibo, solo vino e birra - devi portare il tuo pasto. Atmosfera autentica con tavoli in legno consumati da secoli di brindisi.",
                specialBeer: "Birra Baladin Super",
                founded: "1465",
                specialty: "BYO Food - Porta il tuo cibo!"
            },
            {
                name: "Celtic Druid Irish Pub",
                address: "Via Caduti di Cefalonia 5/c, 40125 Bologna",
                lat: 44.49396,
                lng: 11.34194,
                time: "16:40-17:10",
                emoji: "üçÄ",
                description: "Autentico pub irlandese nel cuore di Bologna! üçÄ Oltre 20 birre alla spina tra cui Guinness e Kilkenny. Ambiente accogliente con musica live nei weekend.",
                specialBeer: "Guinness alla spina perfetta",
                founded: "2003",
                specialty: "Fish & Chips + Guinness"
            },
            {
                name: "Lab16",
                address: "Via Zamboni 16/D, 40126 Bologna",
                lat: 44.49661,
                lng: 11.35203,
                time: "17:20-17:50",
                emoji: "üî¨",
                description: "Birrificio artigianale e laboratorio sperimentale! üî¨ Qui producono birre uniche con ingredienti locali. Ambiente moderno nella zona universitaria, perfetto per scoprire birre innovative.",
                specialBeer: "Birre artigianali autoprodotte",
                founded: "2015",
                specialty: "Sperimentazione + Birre stagionali"
            },
            {
                name: "The Cluricaune Irish Pub",
                address: "Via Zamboni 18/B, 40126 Bologna",
                lat: 44.49676,
                lng: 11.35248,
                time: "17:55-18:25",
                emoji: "‚òòÔ∏è",
                description: "Il pub pi√π famoso di via Zamboni! ‚òòÔ∏è Due piani di atmosfera irlandese pura. Oltre 15 birre alla spina e una selezione vastissima di whiskey. Punto di ritrovo storico per studenti e appassionati.",
                specialBeer: "Murphy's Irish Stout",
                founded: "1997",
                specialty: "Atmosfera autentica + Happy Hour"
            },
            {
                name: "Mutenye Pub",
                address: "Via del Pratello 44/A, 40122 Bologna",
                lat: 44.49326,
                lng: 11.33604,
                time: "18:40-19:10",
                emoji: "ü•®",
                description: "Gemma nascosta del Pratello! ü•® Pub rock con selezione curata di birre belghe e tedesche. Ambiente informale, musica rock dal vivo e aperitivo generoso. Locale cult tra i bolognesi DOC.",
                specialBeer: "Birre belghe d'abbazia",
                founded: "2005",
                specialty: "Rock music + Aperitivo ricco"
            },
            {
                name: "Birreria del Pratello",
                address: "Via del Pratello 24, 40122 Bologna",
                lat: 44.49348,
                lng: 11.33797,
                time: "19:15-19:45",
                emoji: "üéâ",
                description: "Gran finale nel cuore del Pratello! üéâ Oltre 30 birre alla spina e selezione vastissima in bottiglia. Cucina tipica bolognese, ambiente vivace. Il posto perfetto per concludere il tour!",
                specialBeer: "IPA artigianali + Bionde belghe",
                founded: "2010",
                specialty: "Tigelle + 30 birre alla spina"
            }
        ];

        // Avatar options with Font Awesome icons
        const avatarOptions = [
            '<i class="fas fa-user"></i>',
            '<i class="fas fa-user-tie"></i>',
            '<i class="fas fa-user-astronaut"></i>',
            '<i class="fas fa-user-ninja"></i>',
            '<i class="fas fa-user-secret"></i>',
            '<i class="fas fa-beer"></i>',
            '<i class="fas fa-champagne-glasses"></i>',
            '<i class="fas fa-wine-glass"></i>',
            '<i class="fas fa-martini-glass"></i>',
            '<i class="fas fa-beer-mug-empty"></i>'
        ];

        // Initialize Avatar Grid
        function initAvatarGrid() {
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = '';

            avatarOptions.forEach((avatar, index) => {
                const div = document.createElement('div');
                div.className = 'avatar-option';
                if (index === 5) div.classList.add('selected'); // Select beer icon by default
                div.innerHTML = avatar;
                div.onclick = () => selectAvatar(avatar, div);
                grid.appendChild(div);
            });
        }

        // Initialize App
        function startApp() {
            const name = document.getElementById('userName').value.trim() || 'Guest';
            const weight = parseInt(document.getElementById('userWeight').value) || 70;
            const height = parseInt(document.getElementById('userHeight').value) || 175;
            const gender = document.getElementById('userGender').value || 'male';
            const departureTime = document.getElementById('departureTime').value || '16:00';

            appState.user.name = name;
            appState.user.id = generateUserId();
            appState.weight = weight;
            appState.height = height;
            appState.gender = gender;
            appState.departureTime = departureTime; // Save departure time

            // Calculate stop times based on departure
            calculateStopTimes(departureTime);

            // Save to localStorage
            try {
                localStorage.setItem('beerTourUser', JSON.stringify(appState.user));
                localStorage.setItem('beerTourProfile', JSON.stringify({
                    weight: weight,
                    height: height,
                    gender: gender,
                    departureTime: departureTime
                }));
            } catch(e) {
                console.log('localStorage not available');
            }

            // Hide welcome screen
            document.getElementById('welcomeScreen').classList.add('hidden');

            // Update UI
            document.getElementById('userNameDisplay').textContent = name;
            document.getElementById('userAvatar').innerHTML = appState.user.avatar;
            
            // Initialize components
            initializeStops();
            updateSelectedStop(0);
            loadChallenges();

            // Check challenges immediately (e.g., "Too Old to Die Young" for Prosciutto)
            checkChallenges();

            showNotification(`üç∫ Benvenuto ${name}! Buon tour!`);
        }

        function selectAvatar(avatarHTML, element) {
            document.querySelectorAll('.avatar-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            appState.user.avatar = avatarHTML;
        }

        function generateUserId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Calculate stop times dynamically based on departure time
        function calculateStopTimes(departureTime) {
            const [hours, minutes] = departureTime.split(':').map(Number);
            let currentTime = hours * 60 + minutes; // Convert to minutes from midnight

            // Duration at each stop in minutes: 30min each
            const stopDurations = [30, 30, 30, 30, 30, 30]; // 6 stops
            const travelTime = 10; // Travel time between stops in minutes

            locations.forEach((loc, index) => {
                const startTime = currentTime;
                const endTime = currentTime + stopDurations[index];

                // Format times as HH:MM
                const formatTime = (mins) => {
                    const h = Math.floor(mins / 60);
                    const m = mins % 60;
                    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                };

                loc.time = `${formatTime(startTime)}-${formatTime(endTime)}`;

                // Move to next stop (add stop duration + travel time)
                currentTime = endTime + travelTime;
            });

            // Update tour time display
            const firstTime = locations[0].time.split('-')[0];
            const lastTime = locations[locations.length - 1].time.split('-')[1];
            const tourTimeElement = document.getElementById('tourTime');
            if (tourTimeElement) {
                tourTimeElement.textContent = `${firstTime} - ${lastTime}`;
            }
        }

        // Initialize Stops Timeline
        function initializeStops() {
            const container = document.getElementById('stopsContainer');
            container.innerHTML = '';
            
            locations.forEach((loc, index) => {
                const stopDiv = document.createElement('div');
                stopDiv.className = 'stop-item';
                if (index === 0) stopDiv.classList.add('current');
                stopDiv.onclick = () => selectStop(index);
                
                stopDiv.innerHTML = `
                    <div class="stop-circle">${loc.emoji}</div>
                    <div class="stop-name">${loc.name.split(' ')[0]}</div>
                    <div class="stop-time">${loc.time.split('-')[0]}</div>
                `;
                
                container.appendChild(stopDiv);
            });
        }

        function selectStop(index) {
            if (index < 0 || index >= locations.length) return;

            appState.currentLocation = index;
            appState.stopArrivalTimes[index] = new Date();
            updateStopsProgress();
            updateSelectedStop(index);
            document.getElementById('currentStop').textContent = `${index + 1}/6`;

            // Special celebration for last stop!
            if (index === locations.length - 1) {
                showNotification(`üéâüç∫ ULTIMA TAPPA! ${locations[index].name} üç∫üéâ`);

                // Add confetti animation
                setTimeout(() => {
                    showNotification(`üèÅ Tour Completato! Congratulazioni! ü•≥`);
                }, 2000);
            } else {
                showNotification(`üìç Tappa: ${locations[index].name}`);
            }

            checkChallenges(); // Check if any challenges are unlocked with new location
            saveState();
        }

        function updateSelectedStop(index) {
            const loc = locations[index];
            document.getElementById('stopName').textContent = loc.name;
            document.getElementById('stopAddress').textContent = loc.address;
            document.getElementById('stopTime').textContent = loc.time;
            showStopDescription(loc);
        }

        function showStopDescription(location) {
            const stopInfo = document.getElementById('selectedStopInfo');
            if (!stopInfo) return;

            // Remove existing description
            const existing = stopInfo.querySelector('.stop-description');
            if (existing) existing.remove();

            // Create description div
            const descDiv = document.createElement('div');
            descDiv.className = 'stop-description';
            descDiv.innerHTML = `
                <div style="background: linear-gradient(145deg, #FFF9E6, #FFFFFF); padding: 15px; border-radius: 12px; margin: 15px 0; border: 2px solid #2C2C2C;">
                    <p style="color: #2C2C2C; font-size: 13px; line-height: 1.6; margin-bottom: 10px;">
                        ${location.description}
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div style="background: #FDB927; padding: 8px; border-radius: 8px; border: 2px solid #2C2C2C;">
                            <div style="font-size: 10px; font-weight: 600; color: #2C2C2C;">üç∫ Birra Speciale</div>
                            <div style="font-size: 11px; color: #2C2C2C; margin-top: 3px;">${location.specialBeer}</div>
                        </div>
                        <div style="background: #F4A300; padding: 8px; border-radius: 8px; border: 2px solid #2C2C2C;">
                            <div style="font-size: 10px; font-weight: 600; color: #2C2C2C;">üìÖ Fondato</div>
                            <div style="font-size: 11px; color: #2C2C2C; margin-top: 3px;">${location.founded}</div>
                        </div>
                    </div>
                    <div style="background: #66BB6A; padding: 10px; border-radius: 8px; margin-top: 10px; border: 2px solid #2C2C2C;">
                        <div style="font-size: 10px; font-weight: 600; color: white;">‚ú® Specialit√†</div>
                        <div style="font-size: 12px; color: white; margin-top: 3px; font-weight: 700;">${location.specialty}</div>
                    </div>
                </div>
            `;

            // Insert before navigation button
            const navButton = stopInfo.querySelector('.navigation-button');
            if (navButton) {
                stopInfo.insertBefore(descDiv, navButton);
            } else {
                stopInfo.appendChild(descDiv);
            }
        }

        function updateStopsProgress() {
            const stops = document.querySelectorAll('.stop-item');
            stops.forEach((stop, index) => {
                stop.classList.remove('current', 'completed');
                if (index < appState.currentLocation) {
                    stop.classList.add('completed');
                } else if (index === appState.currentLocation) {
                    stop.classList.add('current');
                }
            });
            
            const progress = (appState.currentLocation / (locations.length - 1)) * 100;
            document.getElementById('timelineProgress').style.width = `${progress}%`;
        }

        // Google Maps Navigation
        function openGoogleMaps() {
            const loc = locations[appState.currentLocation];
            const encodedAddress = encodeURIComponent(loc.address);
            const url = `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
            window.open(url, '_blank');
        }

        // Tab Switching
        function switchTab(tabName, element) {
            // Handle badge removal when visiting challenges tab
            if (tabName === 'challenges') {
                hasVisitedChallenges = true;

                // Remove NEW badges after 2 seconds
                setTimeout(() => {
                    challengesData.forEach(c => c.isNew = false);
                    loadChallenges();
                    updateChallengesBadge();
                }, 2000);
            }

            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const tabElement = document.getElementById(`${tabName}-tab`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            if (element) element.classList.add('active');

            // IMPORTANTE: Quando si torna alla tab Home, ri-calcola il thermometro
            // Questo √® necessario perch√© le dimensioni del container erano 0 quando nascosto
            if (tabName === 'home') {
                // Usa setTimeout per dare al browser tempo di renderizzare la tab
                setTimeout(() => {
                    updateThermometer();
                }, 50);
            }
        }

        function quickNav(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            const tabElement = document.getElementById(`${tabName}-tab`);
            if (tabElement) {
                tabElement.classList.add('active');
            }

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            if (element) element.classList.add('active');

            // Update top tabs to match
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnText = btn.querySelector('span:last-child').textContent.toLowerCase();
                if (btnText.includes(tabName.substring(0, 3))) {
                    btn.classList.add('active');
                }
            });

            // IMPORTANTE: Quando si torna alla tab Home, ri-calcola il thermometro
            // Questo √® necessario perch√© le dimensioni del container erano 0 quando nascosto
            if (tabName === 'home') {
                // Usa setTimeout per dare al browser tempo di renderizzare la tab
                setTimeout(() => {
                    updateThermometer();
                }, 50);
            }
        }

        // Beer Functions
        function selectSize(size, volume, element) {
            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            element.classList.add('selected');
            appState.selectedSize = size;
            appState.selectedVolume = volume;
        }

        function selectType(type, element) {
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            element.classList.add('selected');
            appState.selectedType = type;
        }

        // Update alcohol value display
        function updateAlcoholValue(value) {
            const display = document.getElementById('alcoholValue');
            if (display) {
                display.textContent = `${parseFloat(value).toFixed(1)}%`;
            }
        }

        // Set alcohol preset
        function setAlcohol(value) {
            const slider = document.getElementById('alcoholSlider');
            if (slider) {
                slider.value = value;
                updateAlcoholValue(value);
            }
        }

        function addBeer() {
            const alcohol = parseFloat(document.getElementById('alcoholSlider').value) || 5.0;
            const location = locations[appState.currentLocation].name;

            const beer = {
                id: Date.now(),
                location: location,
                size: appState.selectedSize,
                volume: appState.selectedVolume,
                type: appState.selectedType,
                alcohol: alcohol,
                time: new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
            };

            appState.beers.push(beer);
            appState.beersPerLocation[appState.currentLocation]++; // Track beers per location
            updateBeerStats();
            updateBeerList();
            updateThermometer();
            checkChallenges(); // Check for auto-unlock achievements
            saveState();

            showNotification(`üç∫ Birra aggiunta! ${appState.selectedType} (${appState.selectedSize} - ${alcohol}%)`);
        }

        function updateBeerStats() {
            const totalBeers = appState.beers.length;
            const totalLiters = appState.beers.reduce((sum, beer) => sum + beer.volume, 0);
            let avgAlcohol = 0;

            if (totalBeers > 0) {
                avgAlcohol = (appState.beers.reduce((sum, beer) => sum + beer.alcohol, 0) / totalBeers).toFixed(1);
            }

            document.getElementById('totalBeers').textContent = totalBeers;
            document.getElementById('totalLiters').textContent = totalLiters.toFixed(1) + 'L';
            document.getElementById('avgAlcohol').textContent = avgAlcohol + '%';

            document.getElementById('homeBeers').textContent = totalBeers;
            document.getElementById('homeLiters').textContent = totalLiters.toFixed(1) + 'L';

            // Update records
            const bac = calculateBAC();
            document.getElementById('recordBeers').textContent = totalBeers;
            document.getElementById('recordBAC').textContent = bac.toFixed(2) + '‚Ä∞';
        }

        function updateBeerList() {
            const list = document.getElementById('beerList');
            if (!list) return;
            
            list.innerHTML = '';
            
            appState.beers.slice().reverse().forEach(beer => {
                const item = document.createElement('div');
                item.className = 'beer-item';
                item.innerHTML = `
                    <div class="beer-item-info">
                        <div class="beer-item-location">${beer.location}</div>
                        <div class="beer-item-details">
                            ${beer.type || 'Bionda'} ‚Ä¢ ${beer.size} (${beer.volume}L) ‚Ä¢ ${beer.alcohol}% ‚Ä¢ ${beer.time}
                        </div>
                    </div>
                    <button class="remove-beer" onclick="removeBeer(${beer.id})">‚ùå</button>
                `;
                list.appendChild(item);
            });
        }

        function removeBeer(id) {
            appState.beers = appState.beers.filter(beer => beer.id !== id);
            updateBeerStats();
            updateBeerList();
            updateThermometer();
            saveState();
        }

        // BEER LIQUID Thermometer Update
        function updateThermometer() {
            const bac = calculateBAC();
            document.getElementById('homeBAC').textContent = bac.toFixed(2) + '‚Ä∞';

            // Calculate percentage (0-100%)
            // Max display at 6.0‚Ä∞ - everything above is pinned to 100%
            // Con 6.0‚Ä∞ il termometro regge molte pi√π birre (10-15 birre medie)
            const maxBAC = 6.0;
            const percentage = Math.min(100, (bac / maxBAC) * 100);

            console.log(`üîÑ UpdateThermometer: BAC=${bac.toFixed(2)}‚Ä∞, percentage=${percentage.toFixed(1)}%`);

            // Update BEER LIQUID width (fills from left to right)
            const liquidElement = document.getElementById('beerLiquid');
            if (liquidElement) {
                // IMPORTANTE: Usa requestAnimationFrame per forzare il re-render
                // anche quando l'elemento √® nascosto (in una tab non attiva)
                requestAnimationFrame(() => {
                    // Force reflow to ensure DOM is ready
                    void liquidElement.offsetWidth;
                    liquidElement.style.width = `${percentage}%`;
                    console.log(`‚úÖ Liquid updated to ${percentage}%`);
                });
            } else {
                console.error('‚ùå beerLiquid element not found!');
            }

            // Update pointer position (follows the beer level at right edge)
            const pointerElement = document.getElementById('thermometerPointer');
            if (pointerElement) {
                if (percentage > 0) {
                    // IMPORTANTE: Usa requestAnimationFrame per sincronizzare con il liquid update
                    requestAnimationFrame(() => {
                        // Show pointer and position it at the end of the beer liquid
                        pointerElement.classList.add('visible');

                        // Force reflow before reading dimensions
                        const trackElement = document.querySelector('.thermometer-track');
                        if (trackElement) {
                            void trackElement.offsetWidth; // Force reflow
                        }

                        // Usa fallback anche quando offsetWidth √® 0 (elemento nascosto)
                        const containerWidth = (trackElement?.offsetWidth && trackElement.offsetWidth > 0) ? trackElement.offsetWidth : 316;
                        const containerHeight = (trackElement?.offsetHeight && trackElement.offsetHeight > 0) ? trackElement.offsetHeight : 48;
                        const availableWidth = containerWidth - 6;
                        const pointerPos = 3 + Math.min((percentage / 100) * availableWidth, availableWidth - 2);
                        pointerElement.style.left = `${Math.max(3, pointerPos)}px`;

                        // Calculate pointer height based on position to follow border-radius perimeter
                        // The border-radius is 48px, so at the edges the thermometer is narrower
                        const borderRadius = 48;
                        const normalizedPos = pointerPos / containerWidth; // 0 to 1

                        // Distance from center (0 at center, 1 at edges)
                        const distanceFromCenter = Math.abs(normalizedPos - 0.5) * 2;

                        // Calculate height reduction based on circular arc
                        // Using quadratic curve to approximate the border-radius shape
                        const heightReduction = Math.pow(distanceFromCenter, 2) * (borderRadius / containerHeight);
                        const pointerHeight = Math.max(
                            containerHeight * (1 - heightReduction) - 6,
                            containerHeight * 0.3  // Minimum 30% height at edges
                        );

                        pointerElement.style.height = `${pointerHeight}px`;
                        console.log(`‚úÖ Pointer updated: left=${pointerPos.toFixed(1)}px, height=${pointerHeight.toFixed(1)}px`);
                    });
                } else {
                    // Hide pointer when no beer
                    pointerElement.classList.remove('visible');
                }
            } else {
                console.error('‚ùå thermometerPointer element not found!');
            }

            // Update face icon based on BAC with MORE gradations
            const faceElement = document.getElementById('beerFace');
            if (faceElement) {
                let faceIcon;
                let faceColor = '#FDB927';

                if (bac < 0.2) {
                    // Sobrio - Fresh start
                    faceIcon = '<i class="fas fa-face-smile-beam"></i>';
                    faceColor = '#2E7D32';
                } else if (bac < 0.4) {
                    // Leggermente allegro
                    faceIcon = '<i class="fas fa-smile"></i>';
                    faceColor = '#4CAF50';
                } else if (bac < 0.6) {
                    // Allegro
                    faceIcon = '<i class="fas fa-grin"></i>';
                    faceColor = '#7CB342';
                } else if (bac < 0.8) {
                    // Euforico
                    faceIcon = '<i class="fas fa-grin-beam"></i>';
                    faceColor = '#9CCC65';
                } else if (bac < 1.0) {
                    // Brillo
                    faceIcon = '<i class="fas fa-grin-stars"></i>';
                    faceColor = '#CDDC39';
                } else if (bac < 1.3) {
                    // Inizio confusione
                    faceIcon = '<i class="fas fa-face-dizzy"></i>';
                    faceColor = '#FDD835';
                } else if (bac < 1.6) {
                    // Alticcio
                    faceIcon = '<i class="fas fa-face-grin-tongue"></i>';
                    faceColor = '#FFB300';
                } else if (bac < 2.0) {
                    // Stanco
                    faceIcon = '<i class="fas fa-face-tired"></i>';
                    faceColor = '#FF9800';
                } else if (bac < 2.5) {
                    // Molto stanco
                    faceIcon = '<i class="fas fa-face-flushed"></i>';
                    faceColor = '#FF7043';
                } else if (bac < 3.5) {
                    // Problematico
                    faceIcon = '<i class="fas fa-face-frown-open"></i>';
                    faceColor = '#FF5722';
                } else if (bac < 5.0) {
                    // Molto male
                    faceIcon = '<i class="fas fa-face-sad-cry"></i>';
                    faceColor = '#F44336';
                } else {
                    // Critico
                    faceIcon = '<i class="fas fa-skull"></i>';
                    faceColor = '#D32F2F';
                }

                faceElement.innerHTML = faceIcon;
                const iconElement = faceElement.querySelector('i');
                if (iconElement) {
                    iconElement.style.color = faceColor;
                }
                // Emoji is now centered with CSS (left: 50%; transform: translateX(-50%))
            }

            // Show overflow indicator if over scale
            const overflowElement = document.getElementById('overflowIndicator');
            if (overflowElement) {
                if (bac > maxBAC) {
                    overflowElement.style.display = 'block';
                    overflowElement.textContent = `${bac.toFixed(1)}‚Ä∞!`;
                } else {
                    overflowElement.style.display = 'none';
                }
            }
        }

        // CORRECT BAC Calculation Formula
        function calculateBAC() {
            if (appState.beers.length === 0) return 0;
            
            // Calculate total alcohol in grams
            const totalAlcoholGrams = appState.beers.reduce((sum, beer) => {
                // volume in L * 1000 = ml
                // ml * (alcohol% / 100) = ml of pure alcohol
                // ml of pure alcohol * 0.789 = grams of alcohol
                const alcoholGrams = beer.volume * 1000 * (beer.alcohol / 100) * 0.789;
                return sum + alcoholGrams;
            }, 0);
            
            // Widmark formula: BAC = (alcohol in grams / (body weight in grams * r)) * 1000
            // r = 0.68 for men, 0.55 for women
            // Result is in per mille (‚Ä∞)
            const r = appState.gender === 'male' ? 0.68 : 0.55;
            const bodyWeightGrams = appState.weight * 1000;
            
            // The correct formula
            const bac = (totalAlcoholGrams / (bodyWeightGrams * r)) * 1000;
            
            console.log('Debug BAC calculation:', {
                beers: appState.beers.length,
                totalAlcoholGrams: totalAlcoholGrams.toFixed(2),
                weight: appState.weight,
                gender: appState.gender,
                r: r,
                bac: bac.toFixed(2)
            });
            
            return Math.max(0, bac);
        }

        // Settings and Logout Functions
        function openSettings() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">‚öôÔ∏è Impostazioni Profilo</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <input type="text" id="editName" value="${appState.user.name}" placeholder="Nome" style="padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="editWeight" value="${appState.weight}" placeholder="Peso (kg)" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            <input type="number" id="editHeight" value="${appState.height}" placeholder="Altezza (cm)" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <select id="editGender" style="padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            <option value="male" ${appState.gender === 'male' ? 'selected' : ''}>üöπ Uomo</option>
                            <option value="female" ${appState.gender === 'female' ? 'selected' : ''}>üö∫ Donna</option>
                        </select>
                        <button onclick="saveSettings()" style="padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            üíæ Salva Modifiche
                        </button>
                        <button onclick="resetOnlyBeers()" style="padding: 12px; background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            üç∫ Reset Solo Birre
                        </button>
                        <button onclick="resetApp()" style="padding: 12px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            üóëÔ∏è Reset Completo
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function saveSettings() {
            const name = document.getElementById('editName').value || 'Guest';
            const weight = parseInt(document.getElementById('editWeight').value) || 70;
            const height = parseInt(document.getElementById('editHeight').value) || 175;
            const gender = document.getElementById('editGender').value || 'male';
            
            appState.user.name = name;
            appState.weight = weight;
            appState.height = height;
            appState.gender = gender;
            
            // Update UI
            document.getElementById('userNameDisplay').textContent = name;
            
            // Save to localStorage
            try {
                localStorage.setItem('beerTourUser', JSON.stringify(appState.user));
                localStorage.setItem('beerTourProfile', JSON.stringify({
                    weight: weight,
                    height: height,
                    gender: gender
                }));
            } catch(e) {
                console.log('Could not save to localStorage');
            }
            
            // Recalculate BAC with new values
            updateThermometer();
            saveState();
            
            // Close modal
            document.querySelector('.modal').remove();
            showNotification('‚úÖ Profilo aggiornato!');
        }
        
        function resetOnlyBeers() {
            if (confirm('Vuoi resettare solo le birre bevute?')) {
                appState.beers = [];
                updateBeerStats();
                updateBeerList();
                updateThermometer();
                saveState();
                document.querySelector('.modal').remove();
                showNotification('üç∫ Birre resettate!');
            }
        }
        
        function logout() {
            if (confirm('Vuoi davvero uscire? Questo resetter√† tutti i dati del tour.')) {
                resetApp();
            }
        }
        
        function resetApp() {
            // Clear all localStorage
            try {
                localStorage.removeItem('beerTourUser');
                localStorage.removeItem('beerTourProfile');
                localStorage.removeItem('beerTourState');
            } catch(e) {
                console.log('Could not clear localStorage');
            }
            
            // Reload the page
            window.location.reload();
        }

        // Save State
        function saveState() {
            try {
                // Sync challenges completed status to appState
                appState.challenges = challengesData.map(c => ({
                    id: c.id,
                    completed: c.completed
                }));
                localStorage.setItem('beerTourState', JSON.stringify(appState));
            } catch(e) {
                console.log('Could not save state to localStorage');
            }
        }

        // Challenges System
        function loadChallenges() {
            const container = document.getElementById('challengesList');
            if (!container) return;

            container.innerHTML = '';

            challengesData.forEach(challenge => {
                const card = document.createElement('div');
                card.className = `challenge-card ${challenge.completed ? 'completed' : ''} ${challenge.isNew ? 'new-unlock' : ''}`;
                card.onclick = () => toggleChallenge(challenge.id);

                card.innerHTML = `
                    <div class="challenge-icon"><i class="fas ${challenge.icon}"></i></div>
                    <div class="challenge-title">${challenge.title}</div>
                    <div class="challenge-description">${challenge.description}</div>
                    ${!challenge.completed ? `<div class="challenge-points">+${challenge.points}</div>` : ''}
                `;

                container.appendChild(card);
            });
        }

        function toggleChallenge(id) {
            const challenge = challengesData.find(c => c.id === id);
            if (!challenge) return;

            challenge.completed = !challenge.completed;

            if (challenge.completed) {
                appState.points += challenge.points;
                const sign = challenge.points >= 0 ? '+' : '';
                showNotification(`üèÜ Achievement Sbloccato! ${sign}${challenge.points} punti`);
            } else {
                appState.points -= challenge.points;
            }

            loadChallenges();
            updateRecordPoints();
            saveState();
        }

        function checkChallenges() {
            let unlocked = false;
            const bac = calculateBAC();

            // Helper function to unlock challenge
            function unlockChallenge(index, emoji = 'üèÜ') {
                const ch = challengesData[index];
                if (!ch.completed) {
                    ch.completed = true;
                    ch.isNew = true;
                    appState.points += ch.points;
                    const sign = ch.points >= 0 ? '+' : '';
                    showNotification(`${emoji} "${ch.title}" Sbloccato! ${sign}${ch.points} punti`);
                    unlocked = true;
                }
            }

            // 1. Too Old to Die Young (index 0) - Solo per "Prosciutto"
            if (appState.user && appState.user.name &&
                appState.user.name.toLowerCase().trim() === 'prosciutto') {
                unlockChallenge(0, 'üéÇ');
            }

            // 4. Partenza Rinfrescante (index 3) - Prima birra bionda o weiss
            if (appState.beers.length >= 1 && !challengesData[3].completed) {
                const firstBeer = appState.beers[0];
                if (firstBeer.type === 'bionda' || firstBeer.type === 'weiss') {
                    unlockChallenge(3, '‚ùÑÔ∏è');
                }
            }

            // 5. Partenza Ribaltante (index 4) - Prima birra >=7%
            if (appState.beers.length >= 1 && !challengesData[4].completed) {
                const firstBeer = appState.beers[0];
                if (firstBeer.alcohol >= 7) {
                    unlockChallenge(4, '‚ö°');
                }
            }

            // 6. Una Strada in Salita (index 5) - Gradazione media aumenta ogni tappa
            if (appState.currentLocation === 5 && !challengesData[5].completed) {
                // Calcola gradazione media per ogni tappa
                const avgPerLocation = [];
                for (let i = 0; i < 6; i++) {
                    const beersAtLocation = appState.beers.filter((b, idx) => {
                        return appState.beersPerLocation.slice(0, i).reduce((a, c) => a + c, 0) <= idx &&
                               idx < appState.beersPerLocation.slice(0, i + 1).reduce((a, c) => a + c, 0);
                    });
                    if (beersAtLocation.length > 0) {
                        const avg = beersAtLocation.reduce((sum, b) => sum + b.alcohol, 0) / beersAtLocation.length;
                        avgPerLocation.push(avg);
                    }
                }

                // Verifica: prima e ultima tappa strettamente maggiore, altre >=
                let valid = true;
                for (let i = 1; i < avgPerLocation.length; i++) {
                    if (i === 1 || i === avgPerLocation.length - 1) {
                        // Prima e ultima: strettamente maggiore
                        if (avgPerLocation[i] <= avgPerLocation[i - 1]) {
                            valid = false;
                            break;
                        }
                    } else {
                        // Altre: maggiore o uguale
                        if (avgPerLocation[i] < avgPerLocation[i - 1]) {
                            valid = false;
                            break;
                        }
                    }
                }

                if (valid && avgPerLocation.length === 6) {
                    unlockChallenge(5, 'üìà');
                }
            }

            // 7. Montagne Russe (index 6) - Alterna su/gi√π per 3 transizioni (anche non consecutive)
            if (appState.currentLocation >= 3 && !challengesData[6].completed) {
                const avgPerLocation = [];
                for (let i = 0; i <= appState.currentLocation; i++) {
                    const beersAtLocation = appState.beers.filter((b, idx) => {
                        return appState.beersPerLocation.slice(0, i).reduce((a, c) => a + c, 0) <= idx &&
                               idx < appState.beersPerLocation.slice(0, i + 1).reduce((a, c) => a + c, 0);
                    });
                    if (beersAtLocation.length > 0) {
                        const avg = beersAtLocation.reduce((sum, b) => sum + b.alcohol, 0) / beersAtLocation.length;
                        avgPerLocation.push(avg);
                    }
                }

                // Trova transizioni (su/gi√π)
                const transitions = [];
                for (let i = 1; i < avgPerLocation.length; i++) {
                    if (avgPerLocation[i] > avgPerLocation[i - 1]) {
                        transitions.push('up');
                    } else if (avgPerLocation[i] < avgPerLocation[i - 1]) {
                        transitions.push('down');
                    }
                }

                // Conta alternanze (anche non consecutive)
                let alternations = 0;
                for (let i = 1; i < transitions.length; i++) {
                    if (transitions[i] !== transitions[i - 1]) {
                        alternations++;
                    }
                }

                if (alternations >= 3) {
                    unlockChallenge(6, 'üé¢');
                }
            }

            // 8. Etilista (index 7) - BAC >=0.75‚Ä∞ entro 2¬∞ tappa
            if (bac >= 0.75 && appState.currentLocation <= 1) {
                unlockChallenge(7, 'üç∫');
            }

            // 9. Etilista Pro (index 8) - BAC >=1.5‚Ä∞ entro 3¬∞ tappa
            if (bac >= 1.5 && appState.currentLocation <= 2) {
                unlockChallenge(8, 'üî•');
            }

            // 10. Etilista Supremo (index 9) - BAC >=2.5‚Ä∞ entro 5¬∞ tappa
            if (bac >= 2.5 && appState.currentLocation <= 4) {
                unlockChallenge(9, 'üíÄ');
            }

            // 11. Collezionista (index 10) - 5+ variet√† diverse
            const uniqueTypes = [...new Set(appState.beers.map(b => b.type))];
            if (uniqueTypes.length >= 5) {
                unlockChallenge(10, 'üç∑');
            }

            // 12. Un Bicchiere di Troppo (index 11) - 2+ birre per tappa
            if (appState.currentLocation === 5 &&
                appState.beersPerLocation.every(count => count >= 2)) {
                unlockChallenge(11, 'üçª');
            }

            // 14. Normalone (index 13) - Solo birre medie bionde
            if (appState.beers.length > 0 && !challengesData[13].completed) {
                const allNormalone = appState.beers.every(b =>
                    b.size === 'media' && b.type === 'bionda'
                );
                if (allNormalone) {
                    unlockChallenge(13, '‚òï');
                }
            }

            // 15. Passeggiata Pensionante (index 14) - BAC <0.9‚Ä∞ nelle prime 4 tappe
            if (appState.currentLocation >= 3 && bac < 0.9) {
                unlockChallenge(14, 'üö∂');
            }

            // 16. Pensione Completa (index 15) - BAC <1.75‚Ä∞ per tutto il tour
            if (appState.currentLocation === 5 && bac < 1.75) {
                unlockChallenge(15, 'üõèÔ∏è');
            }

            if (unlocked) {
                loadChallenges();
                updateRecordPoints();
                updateChallengesBadge();
                saveState();
            }
        }

        function updateRecordPoints() {
            // Update points in scoreboard if element exists
            const pointsElements = document.querySelectorAll('[id*="points"], [id*="Points"]');
            pointsElements.forEach(el => {
                if (el.textContent !== undefined) {
                    el.textContent = appState.points;
                }
            });
        }

        function updateChallengesBadge() {
            console.log('=== updateChallengesBadge called ===');

            // Find the challenges tab button in the navigation bar
            const tabButtons = document.querySelectorAll('.tab-btn');
            let challengesTab = null;

            tabButtons.forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes('challenges')) {
                    challengesTab = btn;
                }
            });

            console.log('Challenges tab found:', challengesTab);

            if (!challengesTab) {
                console.log('ERROR: Challenges tab button not found!');
                return;
            }

            // Find the trophy icon inside the challenges tab
            const trophyIcon = challengesTab.querySelector('.icon i');
            console.log('Trophy icon found:', trophyIcon);

            // Count NEW challenges (not visited yet)
            const newChallengesCount = challengesData.filter(c => c.completed && c.isNew).length;
            const totalCompleted = challengesData.filter(c => c.completed).length;

            console.log(`New challenges: ${newChallengesCount}, Total completed: ${totalCompleted}, hasVisitedChallenges: ${hasVisitedChallenges}`);

            if (newChallengesCount > 0 && !hasVisitedChallenges) {
                // Make the trophy icon RED using INLINE STYLE (massima priorit√†)
                console.log('ATTEMPTING TO MAKE TROPHY RED - INLINE STYLE');
                if (trophyIcon) {
                    // Forza stile inline con setAttribute - MASSIMA PRIORIT√Ä
                    trophyIcon.setAttribute('style', 'color: #FF0000 !important; filter: brightness(1.5) drop-shadow(0 0 10px rgba(255, 0, 0, 1)) !important;');
                    trophyIcon.classList.add('trophy-has-new-challenges');
                    console.log(`‚úÖ Trophy icon RED FORCED - ${newChallengesCount} new challenges`);
                    console.log('Inline style:', trophyIcon.getAttribute('style'));
                } else {
                    console.log('ERROR: Trophy icon is null!');
                }
            } else {
                // Reset trophy icon to normal (yellow when active, gray when not)
                console.log('Resetting trophy to normal color - REMOVING STYLE');
                if (trophyIcon) {
                    trophyIcon.removeAttribute('style');
                    trophyIcon.classList.remove('trophy-has-new-challenges');
                }
            }
        }

        // Notifications with Queue System
        let notificationTimeout;
        let notificationQueue = [];
        let isShowingNotification = false;

        function showNotification(message) {
            // Add to queue
            notificationQueue.push(message);

            // If not currently showing, start processing queue
            if (!isShowingNotification) {
                processNotificationQueue();
            }
        }

        function processNotificationQueue() {
            if (notificationQueue.length === 0) {
                isShowingNotification = false;
                return;
            }

            isShowingNotification = true;
            const notification = document.getElementById('notification');
            if (!notification) {
                notificationQueue = [];
                isShowingNotification = false;
                return;
            }

            // Get next message from queue
            const message = notificationQueue.shift();

            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }

            notification.textContent = message;
            notification.classList.add('show');

            // Show for 3 seconds, then process next
            notificationTimeout = setTimeout(() => {
                notification.classList.remove('show');

                // Wait 500ms before showing next notification
                setTimeout(() => {
                    processNotificationQueue();
                }, 500);
            }, 3000);
        }

        // Initialize on Load
        window.onload = function() {
            // Initialize avatar grid
            initAvatarGrid();
            
            // Check if user exists
            try {
                const savedUser = localStorage.getItem('beerTourUser');
                const savedProfile = localStorage.getItem('beerTourProfile');
                const savedState = localStorage.getItem('beerTourState');
                
                if (savedUser) {
                    const user = JSON.parse(savedUser);
                    appState.user = user;
                    
                    // Load profile data
                    if (savedProfile) {
                        const profile = JSON.parse(savedProfile);
                        appState.weight = profile.weight || 70;
                        appState.height = profile.height || 175;
                        appState.gender = profile.gender || 'male';
                    }
                    
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        // Merge state carefully, preserving profile data
                        appState = {
                            ...appState,
                            ...state,
                            user: appState.user,
                            weight: appState.weight,
                            height: appState.height,
                            gender: appState.gender
                        };

                        // Restore challenges completed status
                        if (appState.challenges && Array.isArray(appState.challenges)) {
                            appState.challenges.forEach(savedChallenge => {
                                const challenge = challengesData.find(c => c.id === savedChallenge.id);
                                if (challenge) {
                                    challenge.completed = savedChallenge.completed;
                                }
                            });
                        }
                    }

                    document.getElementById('welcomeScreen').classList.add('hidden');
                    document.getElementById('userNameDisplay').textContent = user.name;
                    document.getElementById('userAvatar').innerHTML = user.avatar;
                    
                    // Initialize UI
                    initializeStops();
                    updateBeerStats();
                    updateBeerList();
                    updateThermometer();
                    updateStopsProgress();
                    updateSelectedStop(appState.currentLocation || 0);
                    loadChallenges();
                }
            } catch(e) {
                console.log('Could not load saved state');
            }

            // Always initialize challenges (even for new users)
            if (!document.getElementById('challengesList').hasChildNodes()) {
                loadChallenges();
            }
        };

        // ========================================
        // GOOGLE SHEETS INTEGRATION
        // ========================================

        // ‚ö†Ô∏è IMPORTANTE: Sostituisci questo URL con il tuo Google Apps Script URL
        // Dopo aver deployato lo script, incolla l'URL qui:
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw93CHhCGB2PCtW4RVE6czi3lzr9fO0csM8UfJc_wJQwZAFI3k895Ci-_ABkEjGtvbQaA/exec";

        let leaderboardData = []; // Dati classifica

        // Sync manuale (bottone Sync)
        async function syncWithSheet() {
            if (GOOGLE_SCRIPT_URL === "YOUR_GOOGLE_SCRIPT_URL_HERE" || !GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.trim() === "") {
                showNotification('‚ö†Ô∏è Configura prima il Google Script URL!');
                return;
            }

            // Mostra overlay e blocca UI
            const overlay = document.getElementById('syncOverlay');
            if (overlay) {
                overlay.classList.add('active');
            }

            try {
                // Upload user data
                await uploadUserData();

                // Download leaderboard
                await downloadLeaderboard();

                // Download shared photos
                await downloadSharedPhotos();

                // Nascondi overlay e mostra notifica successo
                if (overlay) {
                    overlay.classList.remove('active');
                }
                showNotification('‚úÖ Sincronizzato con successo!');
            } catch (error) {
                console.error('Sync error:', error);
                // Nascondi overlay anche in caso di errore
                if (overlay) {
                    overlay.classList.remove('active');
                }
                showNotification('‚ùå Errore sincronizzazione');
            }
        }

        // Upload user data to Google Sheets
        async function uploadUserData() {
            const userData = {
                action: "sync",
                user_name: appState.user.name,
                beers_count: appState.beers.length,
                bac: calculateBAC(),
                current_location: locations[appState.currentLocation]?.name || "Unknown",
                points: appState.points,
                achievements: challengesData.filter(c => c.completed).map(c => c.id),
                lat: locations[appState.currentLocation]?.lat || 0,
                lng: locations[appState.currentLocation]?.lng || 0
            };

            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            });

            return response;
        }

        // Download leaderboard from Google Sheets
        async function downloadLeaderboard() {
            const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getData`);
            const result = await response.json();

            if (result.status === "success") {
                leaderboardData = result.data;
                updateLeaderboardUI();
            }
        }

        // Update leaderboard UI
        function updateLeaderboardUI() {
            // Sort by points
            const sorted = leaderboardData.sort((a, b) => b.points - a.points);

            // Update scoreboard tab with live data
            const scoreboardTab = document.getElementById('scoreboard-tab');
            if (!scoreboardTab) return;

            let html = `
                <div style="padding: 20px; padding-top: 10px;">
                    <h2 style="text-align: center; color: #2C2C2C; margin-bottom: 20px; margin-top: 5px;">
                        <i class="fas fa-trophy" style="color: #FDB927;"></i> Classifica Live
                    </h2>
            `;

            sorted.forEach((user, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                const isCurrentUser = user.user_name === appState.user.name;

                html += `
                    <div style="
                        background: ${isCurrentUser ? 'linear-gradient(135deg, #FDB927 0%, #F4A300 100%)' : 'white'};
                        padding: 15px;
                        margin-bottom: 10px;
                        border-radius: 15px;
                        border: 3px solid #2C2C2C;
                        ${isCurrentUser ? 'box-shadow: 0 6px 20px rgba(253, 185, 39, 0.4);' : ''}
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 20px; font-weight: 900; color: ${isCurrentUser ? '#2C2C2C' : '#333'};">
                                    ${medal} ${user.user_name}
                                </div>
                                <div style="font-size: 14px; color: ${isCurrentUser ? '#2C2C2C' : '#666'}; margin-top: 5px;">
                                    üç∫ ${user.beers_count} birre | üíõ ${parseFloat(user.bac).toFixed(2)}‚Ä∞ | üìç ${user.current_location}
                                </div>
                            </div>
                            <div style="font-size: 24px; font-weight: 900; color: ${isCurrentUser ? '#2C2C2C' : '#FDB927'};">
                                ${user.points}
                            </div>
                        </div>
                    </div>
                `;
            });

            // Add timestamp
            html += `
                    <div style="text-align: center; margin-top: 20px; color: #666; font-size: 13px;">
                        ‚è±Ô∏è Ultimo aggiornamento: ${new Date().toLocaleTimeString('it-IT')}
                    </div>
                </div>
            `;

            scoreboardTab.innerHTML = html;
        }

        // Upload photo to Google Sheets
        async function uploadPhotoToSheet(photoData) {
            const data = {
                action: "uploadPhoto",
                user_name: appState.user.name,
                photo_data: photoData,
                location: locations[appState.currentLocation]?.name || "Unknown"
            };

            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
        }

        // Download shared photos from Google Sheets
        async function downloadSharedPhotos() {
            const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getPhotos`);
            const result = await response.json();

            if (result.status === "success") {
                sharedPhotos = result.data;
                updateSharedPhotoGallery();
            }
        }

        // Update shared photo gallery UI
        function updateSharedPhotoGallery() {
            const grid = document.getElementById('photoGrid');
            if (!grid) return;

            grid.innerHTML = '';

            // Show last 50 photos (limit for performance)
            const photosToShow = sharedPhotos.slice(-50);

            photosToShow.forEach((photo) => {
                const slot = document.createElement('div');
                slot.className = 'photo-slot';
                slot.style.position = 'relative';

                slot.innerHTML = `
                    <img src="${photo.photo_data}" alt="Photo" style="width: 100%; height: 100%; object-fit: cover;">
                    <div style="
                        position: absolute;
                        bottom: 0;
                        left: 0;
                        right: 0;
                        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
                        color: white;
                        padding: 5px;
                        font-size: 11px;
                        font-weight: 600;
                    ">
                        ${photo.user_name}
                    </div>
                `;

                grid.appendChild(slot);
            });

            // Add upload button at the end
            const uploadSlot = document.createElement('div');
            uploadSlot.className = 'photo-slot';
            uploadSlot.style.cursor = 'pointer';
            uploadSlot.onclick = () => document.getElementById('photoInput').click();
            uploadSlot.innerHTML = '<div class="add-photo"><i class="fas fa-camera"></i></div>';
            grid.appendChild(uploadSlot);
        }

        // Modified handlePhotoUpload to also upload to Google Sheets
        const originalHandlePhotoUpload = handlePhotoUpload;
        handlePhotoUpload = function(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            Array.from(files).forEach((file) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const photoData = e.target.result;

                    // Save locally
                    appState.photos.push(photoData);

                    // Upload to Google Sheets (if configured)
                    if (GOOGLE_SCRIPT_URL !== "YOUR_GOOGLE_SCRIPT_URL_HERE" && GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.trim() !== "") {
                        try {
                            await uploadPhotoToSheet(photoData);
                            await downloadSharedPhotos(); // Refresh gallery
                            checkChallenges();
                        } catch (error) {
                            console.error('Photo upload error:', error);
                        }
                    } else {
                        // Fallback to local gallery only
                        checkChallenges();
                    }

                    saveState();
                };
                reader.readAsDataURL(file);
            });

            event.target.value = '';
        };



    </script>
</body>
</html>
